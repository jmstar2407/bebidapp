<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebidapp - Sistema de facturaci√≥n</title>
    <link rel="icon" href="./img/icon 512x512.png" type="image/png" sizes="any">
    <link rel="stylesheet" href="./css/style.css">
    <script src="./js/header-component.js"></script>

</head>

<body>

    <header-component></header-component>

    <div class="container">

        <div class="main-layout">
            <div class="left-panel">
                <div class="search-section">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Buscar productos...">
                    <select class="category-filter" id="categoryFilter">
                        <option value="">Todas las categor√≠as</option>
                        <!-- Las categor√≠as se llenar√°n din√°micamente -->
                    </select>
                    <div class="view-toggle">
                        <button class="view-btn active" id="gridViewBtn" onclick="toggleViewMode('grid')"><img
                                src="./img/icons/grid.png"></button>
                        <button class="view-btn" id="listViewBtn" onclick="toggleViewMode('list')"><img
                                src="./img/icons/list.png"></button>
                    </div>
                </div>

                <div class="products-grid">
                    <div class="products-container" id="productsContainer">
                        <div class="loading-spinner">Cargando productos...</div>
                    </div>
                </div>

                <div class="mesas-section">
                    <div class="mesas-grid" id="mesasGrid">
                        <!-- Las mesas se generar√°n aqu√≠ -->
                    </div>
                    <button class="quick-sale-btn" onclick="selectQuickSale()">‚ö° Factura R√°pida</button>
                </div>
            </div>

            <div class="right-panel">
                <div class="current-order">
                    <div class="order-header">
                        <h3 id="orderTitle">‚ö° Factura R√°pida</h3>
                    </div>

                    <div class="order-items" id="orderItems">
                        <!-- Los items del pedido se mostrar√°n aqu√≠ -->
                    </div>

                    <div class="order-footer">
                        <div class="order-total">
                            <div class="total-label">Total:</div>
                            <div class="total-amount" id="totalAmount">$0.00</div>
                        </div>

                        <div class="payment-section">
                            <button class="btn-facturar" onclick="processPayment()">Facturar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Copyright 2025 - Developed By Jos√© Polanco</p>
        </div>
    </div>

    <!-- Modal para procesar pago -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">

            <div class="Modal-Title">
                <h3>Procesar Factura</h3>
                <button class="close-modal-btn" onclick="closePaymentModal()">√ó</button>
            </div>

            <div class="Modal-Body" id="bodyfactura">
                <div class="payment-modal-layout">
                    <div class="payment-left-section">
                        <div class="payment-summary" id="paymentSummary">
                            <!-- Resumen de productos se mostrar√° aqu√≠ -->
                        </div>

                        <div class="input-group"
                            style="background: #ffffff;display: inline-flex;flex-direction: column;align-items: center;border-radius: 7px;">
                            <label>M√©todo de Pago:</label>
                            <div class="payment-methods">
                                <button class="payment-btn payment-efectivo active"
                                    onclick="selectPaymentMethod('efectivo')">Efectivo</button>
                                <!-- <button class="payment-btn payment-tarjeta"
                                    onclick="selectPaymentMethod('tarjeta')">Tarjeta</button> -->
                                <!--  <button class="payment-btn payment-transferencia"
                                    onclick="selectPaymentMethod('transferencia')">Transferencia</button> -->
                            </div>
                            <input type="hidden" id="paymentMethod" value="efectivo">
                        </div>




                    </div>

                    <div class="payment-right-section">

                        <div class="input-group" id="receivedGroup">
                            <label>Dinero Recibido:</label>
                            <input type="number" id="receivedAmount" placeholder="0" step="0.01">
                        </div>

                        <div class="input-group" id="changeGroup">
                            <label>Cambio:</label>
                            <input type="text" id="changeAmount" readonly>
                        </div>


                        <div class="numeric-keyboard">
                            <button class="numeric-key" onclick="appendToAmount('7')">7</button>
                            <button class="numeric-key" onclick="appendToAmount('8')">8</button>
                            <button class="numeric-key" onclick="appendToAmount('9')">9</button>
                            <button class="numeric-key" onclick="appendToAmount('4')">4</button>
                            <button class="numeric-key" onclick="appendToAmount('5')">5</button>
                            <button class="numeric-key" onclick="appendToAmount('6')">6</button>
                            <button class="numeric-key" onclick="appendToAmount('1')">1</button>
                            <button class="numeric-key" onclick="appendToAmount('2')">2</button>
                            <button class="numeric-key" onclick="appendToAmount('3')">3</button>
                            <button class="numeric-key" onclick="removeLastDigit()" id="clearBtn"><span><img
                                        src="./img/icons/borrar_1.png"></span></button>
                            <button class="numeric-key" onclick="appendToAmount('0')">0</button>
                            <button class="numeric-key" onclick="clearAmount()" id="clearBtn"><img
                                    src="./img/icons/borrar_2.png"></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="Modal-Footer">
                <div class="modal-buttons">
                    <!-- <button class="btn-secondary" onclick="closePaymentModal()">Cancelar</button> -->
                    <button class="btn-primary" onclick="confirmPayment()">Confirmar Pago</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal para vista previa de factura -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content">

            <div class="Modal-Title">
                <h3>üìÑ Vista Previa Factura</h3>
            </div>

            <div class="Modal-Body" id="bodyfactura">
                <div class="invoice-preview" id="invoicePreview">
                    <!-- Contenido de la factura se generar√° aqu√≠ -->
                </div>
            </div>

            <div class="Modal-Footer">
                <button class="btn-secondary" onclick="closeInvoiceModal()">Cancelar</button>
                <button class="btn-primary" onclick="printInvoice()">üñ®Ô∏è Imprimir Factura</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>

    <script>

// Configuraci√≥n de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCa3ntHg9DqV3JefcvFP9cg8xCmwm0wlLo",
    authDomain: "facturacion-drink.firebaseapp.com",
    projectId: "facturacion-drink",
    storageBucket: "facturacion-drink.appspot.com",
    messagingSenderId: "1093109447685",
    appId: "1:1093109447685:web:a3015f3494f757a625b06c"
};

// Inicializar Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();   // üëà agregado
const db = firebase.firestore();

// Verificar autenticaci√≥n antes de cargar la app
auth.onAuthStateChanged((user) => {
    if (!user) {
        // Si no hay sesi√≥n activa, redirigir al login
        window.location.href = 'login.html';
    } else {
        // Si hay sesi√≥n, cargar la app
        initializeApp();
    }
});

// Estado de la aplicaci√≥n
let currentMesa = 'mesa1';
let isQuickSale = false;
let productos = [];
let mesas = {};
let currentEditingMesa = null;
let viewMode = localStorage.getItem('productViewMode') || 'grid';


        // Productos de ejemplo (solo como respaldo si Firestore falla)
        const sampleProducts = [
            { id: 'prod1', name: 'Cerveza Corona', price: 3.50, stock: 100, image: 'üç∫', description: '' },
            { id: 'prod2', name: 'Ron Barcel√≥', price: 8.00, stock: 25, image: 'ü•É', description: '' },
            { id: 'prod3', name: 'Vodka Absolut', price: 10.00, stock: 15, image: 'üç∏', description: '' },
            { id: 'prod4', name: 'Whisky Johnnie Walker', price: 12.00, stock: 20, image: 'ü•É', description: '' },
            { id: 'prod5', name: 'Tequila Jose Cuervo', price: 9.50, stock: 18, image: 'üçπ', description: '' },
            { id: 'prod6', name: 'Gin Bombay', price: 11.00, stock: 22, image: 'üç∏', description: '' },
            { id: 'prod7', name: 'Mojito', price: 6.50, stock: 50, image: 'üçπ', description: '' },
            { id: 'prod8', name: 'Pi√±a Colada', price: 7.00, stock: 45, image: 'ü••', description: '' }
        ];

        // Funci√≥n para configurar el listener de mesas
        function setupMesasListener() {
            db.collection('mesas').onSnapshot((snapshot) => {
                mesas = {};
                snapshot.forEach((doc) => {
                    const mesaData = doc.data();
                    mesas[doc.id] = {
                        name: mesaData.name || `Mesa ${doc.id}`,
                        items: mesaData.items || [],
                        total: mesaData.total || 0
                    };
                });

                // Si no hay mesas, crea algunas por defecto
                if (Object.keys(mesas).length === 0) {
                    createDefaultMesas();
                }

                renderMesas();

                // Si la mesa actual fue eliminada, selecciona la primera disponible
                if (currentMesa && !mesas[currentMesa]) {
                    const firstMesaId = Object.keys(mesas)[0];
                    if (firstMesaId) {
                        selectMesa(firstMesaId);
                    } else {
                        currentMesa = null;
                        updateOrderDisplay();
                    }
                }
            }, (error) => {
                console.error('Error en listener de mesas:', error);
                showNotification('Error al cargar mesas', 'error');
            });
        }

        // Funci√≥n para crear mesas por defecto si no hay ninguna
        async function createDefaultMesas() {
            const defaultMesas = {
                mesa1: { name: 'Mesa 1', items: [], total: 0 },
                mesa2: { name: 'Mesa 2', items: [], total: 0 },
                mesa3: { name: 'Mesa 3', items: [], total: 0 },
                mesa4: { name: 'Mesa 4', items: [], total: 0 }
            };

            const batch = db.batch();

            for (const [id, mesa] of Object.entries(defaultMesas)) {
                const mesaRef = db.collection('mesas').doc(id);
                batch.set(mesaRef, mesa);
            }

            try {
                await batch.commit();
            } catch (error) {
                console.error('Error al crear mesas por defecto:', error);
            }
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        async function initializeApp() {
            try {
                // Mostrar spinner de carga
                document.getElementById('productsContainer').innerHTML = '<div class="loading-spinner">Cargando productos...</div>';
                document.getElementById('gridViewBtn').classList.toggle('active', viewMode === 'grid');
                document.getElementById('listViewBtn').classList.toggle('active', viewMode === 'list');

                // Cargar productos desde Firestore
                await loadProductsFromFirestore();

                // Configurar listener en tiempo real para mesas
                await setupMesasListener();

                // Renderizar interfaz
                renderProducts();

                // Seleccionar factura r√°pida al iniciar
                selectQuickSale();

                // Configurar eventos
                setupEventListeners();


            } catch (error) {
                console.error('Error al inicializar:', error);
                showNotification('Error al inicializar el sistema', 'error');
            }
        }


        function setupEventListeners() {
            // B√∫squeda de productos
            document.getElementById('searchBox').addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                renderProducts(searchTerm);
            });

            // Eventos del modal de pago
            document.getElementById('paymentMethod').addEventListener('change', function (e) {
                const isEfectivo = e.target.value === 'efectivo';
                document.getElementById('receivedGroup').style.display = isEfectivo ? 'block' : 'none';
                document.getElementById('changeGroup').style.display = isEfectivo ? 'block' : 'none';
            });

            document.getElementById('receivedAmount').addEventListener('input', function (e) {
                const received = parseFloat(e.target.value) || 0;
                const total = parseFloat(document.getElementById('paymentAmount').value) || 0;
                const change = received - total;
                document.getElementById('changeAmount').value = change >= 0 ? change.toFixed(0) : '0';
            });

            // Cerrar modales al hacer clic fuera
            /*
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
            */
        }

        // Funci√≥n para cargar productos desde Firestore
        async function loadProductsFromFirestore() {
            try {
                // Cargar categor√≠as primero
                const categoriesSnapshot = await db.collection('categories').get();
                const categories = categoriesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name
                }));

                // Cargar productos
                const snapshot = await db.collection('products').get();
                productos = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const category = categories.find(cat => cat.id === data.category);
                    return {
                        id: doc.id,
                        name: data.name,
                        price: Number(data.price),
                        stock: Number(data.stock),
                        image: data.icon || 'üõí',
                        description: data.description || '',
                        category: category ? category.name : 'Sin categor√≠a',
                        categoryId: data.category || ''
                    };
                });

                // Actualizar selector de categor√≠as
                updateCategoryFilter(categories);

                if (productos.length === 0) {
                    console.warn('No hay productos en Firestore, usando datos de muestra');
                    productos = sampleProducts;
                }
            } catch (error) {
                console.error('Error al cargar productos:', error);
                showNotification('Error al cargar productos', 'error');
                productos = sampleProducts;
            }
        }

        function updateCategoryFilter(categories) {
            const filter = document.getElementById('categoryFilter');
            filter.innerHTML = '<option value="">Todas las categor√≠as</option>';

            categories.forEach(category => {
                filter.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });

            // A√±adir evento para filtrar
            filter.addEventListener('change', function () {
                renderProducts();
            });
        }

        // Agrega esta funci√≥n para cambiar entre vistas
        function toggleViewMode(mode) {
            viewMode = mode;
            localStorage.setItem('productViewMode', mode);

            // Actualizar botones activos
            document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');

            renderProducts();
        }


        function renderProducts(searchTerm = '') {
            const container = document.getElementById('productsContainer');
            const categoryFilter = document.getElementById('categoryFilter').value;

            const filteredProducts = productos.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = !categoryFilter || product.categoryId === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            if (filteredProducts.length === 0) {
                container.innerHTML = '<div class="no-products">No se encontraron productos</div>';
                return;
            }

            // Aplicar clase seg√∫n el modo de vista
            container.className = 'products-container';
            if (viewMode === 'list') {
                container.classList.add('list-view');
            }

            container.innerHTML = filteredProducts.map(product => {
                let imageContent;
                if (product.image.startsWith('http') || product.image.startsWith('data:image')) {
                    imageContent = `<img src="${product.image}" alt="${product.name}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
                } else {
                    imageContent = `<div style="font-size:48px;">${product.image}</div>`;
                }

                return `
        <div class="product-card ${viewMode === 'list' ? 'list-view' : ''}" onclick="addProductToOrder('${product.id}')">
            <div class="product-image">${imageContent}</div>
            <div id="divlistview">
            <div class="product-name">${product.name}</div>
            <!-- ${viewMode === 'grid' ? `<div class="product-category">${product.category}</div>` : ''} -->
            <div class="product-category">${product.category}</div>
            <div class="product-price">RD$${formatNumber(product.price)}</div>
            <!-- ${viewMode === 'grid' ? `<div class="product-stock">Stock: ${product.stock}</div>` : ''} -->
            <div class="product-stock">Stock: ${product.stock}</div>
            </div>
        </div>
        `;
            }).join('');
        }

        function renderMesas() {
            const container = document.getElementById('mesasGrid');

            // Ordenar mesas por nombre
            const sortedMesas = Object.entries(mesas)
                .sort((a, b) => a[1].name.localeCompare(b[1].name));

            container.innerHTML = sortedMesas.map(([mesaId, mesa]) => {
                const hasItems = mesa.items.length > 0;
                const isActive = currentMesa === mesaId && !isQuickSale;

                return `
            <button class="mesa-btn ${isActive ? 'active' : ''} ${hasItems ? 'has-items' : ''}" 
                    onclick="selectMesa('${mesaId}')">
                ${mesa.name}
                ${hasItems ? `<br><small>$${mesa.total.toFixed(0)}</small>` : ''}
            </button>
        `;
            }).join('');
        }

        function selectMesa(mesaId) {
            if (mesas[mesaId]) {
                currentMesa = mesaId;
                isQuickSale = false;
                updateOrderDisplay();
                renderMesas();
                // Remover clase active del bot√≥n de factura r√°pida
                document.querySelector('.quick-sale-btn').classList.remove('active');
            } else {
                showNotification('Mesa no encontrada', 'error');
            }
        }

        function selectQuickSale() {
            isQuickSale = true;
            currentMesa = null;
            updateOrderDisplay();
            renderMesas();
            // Agregar clase active al bot√≥n de factura r√°pida
            document.querySelector('.quick-sale-btn').classList.add('active');
        }


        async function addProductToOrder(productId) {
            const product = productos.find(p => p.id === productId);
            if (!product) return;

            if (product.stock <= 0) {
                showNotification('Producto sin stock', 'error');
                return;
            }

            let targetOrder;
            if (isQuickSale) {
                if (!window.quickOrder) {
                    window.quickOrder = { items: [], total: 0 };
                }
                targetOrder = window.quickOrder;
            } else {
                if (!currentMesa || !mesas[currentMesa]) {
                    showNotification('Selecciona una mesa primero', 'error');
                    return;
                }
                targetOrder = mesas[currentMesa];
            }

            const existingItem = targetOrder.items.find(item => item.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.subtotal = existingItem.quantity * existingItem.price;
            } else {
                targetOrder.items.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    subtotal: product.price
                });
            }

            targetOrder.total = targetOrder.items.reduce((sum, item) => sum + item.subtotal, 0);

            // Actualizar Firebase si no es quick sale
            if (!isQuickSale) {
                try {
                    await db.collection('mesas').doc(currentMesa).update({
                        items: targetOrder.items,
                        total: targetOrder.total
                    });
                } catch (error) {
                    console.error('Error al actualizar mesa:', error);
                    showNotification('Error al actualizar mesa', 'error');
                    return;
                }
            }

            updateOrderDisplay();
            renderMesas();
            showNotification(`${product.name} agregado`, 'success');
        }

        function updateOrderDisplay() {
            let currentOrder;
            let orderTitle;

            if (isQuickSale) {
                currentOrder = window.quickOrder || { items: [], total: 0 };
                orderTitle = '‚ö° Factura R√°pida';
            } else {
                if (!mesas || !mesas[currentMesa]) {
                    currentOrder = { items: [], total: 0 };
                    orderTitle = 'Seleccione una mesa';
                } else {
                    currentOrder = mesas[currentMesa];
                    orderTitle = mesas[currentMesa].name;
                }
            }

            document.getElementById('orderTitle').textContent = orderTitle;

            const itemsContainer = document.getElementById('orderItems');
            if (currentOrder.items.length === 0) {
                itemsContainer.innerHTML = `
                <div style="text-align: center; color: #a0aec0; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üõí</div>
                    <div>No hay productos en el pedido</div>
                </div>
            `;
            } else {
                itemsContainer.innerHTML = currentOrder.items.map(item => {
                    const product = productos.find(p => p.id === item.id);
                    let iconContent;

                    if (product) {
                        if (product.image.startsWith('http') || product.image.startsWith('data:image')) {
                            iconContent = `<img src="${product.image}" alt="${product.name}" class="order-item-image">`;
                        } else {
                            iconContent = `<div class="order-item-emoji">${product.image}</div>`;
                        }
                    } else {
                        iconContent = '<div class="order-item-emoji">üõí</div>';
                    }

                    return `
                    <div class="order-item">
                        <div class="item-icon">${iconContent}</div>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">RD$${formatNumber(item.price)} c/u</div>
                        </div>
                        <div class="item-controls">
                            <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                            <div class="qty-display">${item.quantity}</div>
                            <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                            <button class="remove-btn" onclick="confirmRemoveItem('${item.id}')"><img src="./img/icons/papelera_1.png" style="height: 100%;"></button>
                        </div>
                    </div>
                `;
                }).join('');
            }

            document.getElementById('totalAmount').textContent = `RD$${formatNumber(currentOrder.total, true)}`;
        }


        // A√±adir esta funci√≥n para formatear n√∫meros:
        function formatNumber(amount, removeDecimals = false) {
            let formatted;
            if (removeDecimals) {
                formatted = Math.round(amount).toLocaleString('en-US');
            } else {
                formatted = amount.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
            return formatted;
        }


        function confirmRemoveItem(productId) {
            const product = productos.find(p => p.id === productId);
            const productName = product ? product.name : 'este art√≠culo';

            if (confirm(`¬øEst√°s seguro de que quieres eliminar ${productName} del pedido?`)) {
                removeItem(productId);
            }
        }

        async function updateQuantity(productId, change) {
            let targetOrder;
            if (isQuickSale) {
                targetOrder = window.quickOrder;
            } else {
                targetOrder = mesas[currentMesa];
            }

            const item = targetOrder.items.find(item => item.id === productId);
            if (!item) return;

            const newQuantity = item.quantity + change;

            if (newQuantity <= 0) {
                const product = productos.find(p => p.id === productId);
                const productName = product ? product.name : 'este art√≠culo';

                if (confirm(`¬øEst√°s seguro de que quieres eliminar ${productName} del pedido?`)) {
                    await removeItem(productId);
                }
                return;
            }

            const product = productos.find(p => p.id === productId);
            if (newQuantity > product.stock) {
                showNotification('No hay suficiente stock', 'error');
                return;
            }

            item.quantity = newQuantity;
            item.subtotal = item.quantity * item.price;
            targetOrder.total = targetOrder.items.reduce((sum, item) => sum + item.subtotal, 0);

            // Actualizar Firebase si no es quick sale
            if (!isQuickSale) {
                try {
                    await db.collection('mesas').doc(currentMesa).update({
                        items: targetOrder.items,
                        total: targetOrder.total
                    });
                } catch (error) {
                    console.error('Error al actualizar mesa:', error);
                    showNotification('Error al actualizar mesa', 'error');
                    return;
                }
            }

            updateOrderDisplay();
            renderMesas();
        }

        async function removeItem(productId) {
            let targetOrder;
            if (isQuickSale) {
                targetOrder = window.quickOrder;
            } else {
                targetOrder = mesas[currentMesa];
            }

            const itemIndex = targetOrder.items.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                targetOrder.items.splice(itemIndex, 1);
                targetOrder.total = targetOrder.items.reduce((sum, item) => sum + item.subtotal, 0);

                // Actualizar Firebase si no es quick sale
                if (!isQuickSale) {
                    try {
                        await db.collection('mesas').doc(currentMesa).update({
                            items: targetOrder.items,
                            total: targetOrder.total
                        });
                    } catch (error) {
                        console.error('Error al actualizar mesa:', error);
                        showNotification('Error al actualizar mesa', 'error');
                        return;
                    }
                }

                updateOrderDisplay();
                renderMesas();
                showNotification('Producto eliminado', 'success');
            }
        }

        function removeLastDigit() {
            const input = document.getElementById('receivedAmount');
            let currentValue = input.value;

            if (currentValue.length > 0) {
                // Eliminar el √∫ltimo car√°cter
                input.value = currentValue.slice(0, -1);

                // Si queda vac√≠o, poner "0"
                if (input.value === '') {
                    input.value = '0';
                }

                // Disparar el evento input para actualizar el cambio
                const event = new Event('input');
                input.dispatchEvent(event);
            }
        }

        function selectPaymentMethod(method) {
            // Quitar clase active de todos los botones
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // A√±adir clase active al bot√≥n seleccionado
            document.querySelector(`.payment-${method}`).classList.add('active');

            // Actualizar el valor del m√©todo de pago
            document.getElementById('paymentMethod').value = method;

            // Mostrar/ocultar campos seg√∫n el m√©todo
            const isEfectivo = method === 'efectivo';
            document.getElementById('receivedGroup').style.display = isEfectivo ? 'block' : 'none';
            document.getElementById('changeGroup').style.display = isEfectivo ? 'block' : 'none';
        }

        function processPayment() {
            let currentOrder;
            if (isQuickSale) {
                currentOrder = window.quickOrder || { items: [], total: 0 };
            } else {
                currentOrder = mesas[currentMesa];
            }

            if (currentOrder.items.length === 0) {
                showNotification('No hay productos para facturar', 'error');
                return;
            }

            //document.getElementById('paymentMethod').value = 'efectivo';
            document.getElementById('receivedAmount').value = '';
            document.getElementById('changeAmount').value = '0';

            if (!document.getElementById('paymentAmount')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.id = 'paymentAmount';
                input.value = currentOrder.total.toFixed(0);
                document.getElementById('paymentModal').querySelector('.modal-content').appendChild(input);
            } else {
                document.getElementById('paymentAmount').value = currentOrder.total.toFixed(0);
            }

            document.getElementById('receivedGroup').style.display = 'block';
            document.getElementById('changeGroup').style.display = 'block';

            updatePaymentSummary(currentOrder);

            document.getElementById('receivedAmount').addEventListener('input', function (e) {
                const received = parseFloat(e.target.value) || 0;
                const total = parseFloat(document.getElementById('paymentAmount').value) || 0;
                const change = received - total;

                const changeInput = document.getElementById('changeAmount');
                if (change >= 0) {
                    changeInput.value = change.toFixed(0);
                    changeInput.style.color = '#38a169';
                } else {
                    changeInput.value = Math.abs(change).toFixed(0);
                    changeInput.style.color = '#e53e3e';
                }
            });

            document.getElementById('paymentModal').classList.add('active');
        }

        function updatePaymentSummary(order) {
            const summaryContainer = document.getElementById('paymentSummary');

            let summaryHTML = `
            <p>Factura<p>
        <div class="payment-summary-header">
            <span>Productos</span>
            <span>Precio</span>
            <span>Cant.</span>
            <span>Subtotal</span>
        </div>
    `;

            summaryHTML += order.items.map(item => `
        <div class="payment-summary-item">
            <span>${item.name}</span>
            <span>RD$${item.price.toFixed(0)}</span>
            <span>x${item.quantity}</span>
            <span>RD$${item.subtotal.toFixed(0)}</span>
        </div>
    `).join('');

            summaryHTML += `
        <div class="payment-summary-total">
            <span colspan="3">Total:</span>
            <span>RD$${order.total.toFixed(0)}</span>
        </div>
    `;

            summaryContainer.innerHTML = summaryHTML;
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function appendToAmount(value) {
            const input = document.getElementById('receivedAmount');
            const currentValue = input.value;

            if (currentValue === '0' && value !== '00') {
                input.value = value;
            } else if (currentValue.includes('.') && currentValue.split('.')[1].length >= 2) {
                return;
            } else if (value === '00' && currentValue === '') {
                input.value = '0';
            } else {
                input.value += value;
            }

            const event = new Event('input');
            input.dispatchEvent(event);
        }

        function clearAmount() {
            document.getElementById('receivedAmount').value = '';
            document.getElementById('changeAmount').value = '0.00';
        }

        async function confirmPayment() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const receivedAmount = parseFloat(document.getElementById('receivedAmount').value) || 0;
            const changeAmount = parseFloat(document.getElementById('changeAmount').value) || 0;

            let currentOrder;
            if (isQuickSale) {
                currentOrder = window.quickOrder || { items: [], total: 0 };
            } else {
                currentOrder = mesas[currentMesa];
            }

            const totalAmount = currentOrder.total;

            if (paymentMethod === 'efectivo' && receivedAmount < totalAmount) {
                showNotification('El dinero recibido es insuficiente', 'error');
                return;
            }

            if (currentOrder.items.length === 0) {
                showNotification('No hay productos para facturar', 'error');
                return;
            }

            try {
                const invoice = {
                    id: generateInvoiceId(),
                    timestamp: new Date(),
                    mesa: isQuickSale ? 'Factura R√°pida' : mesas[currentMesa].name,
                    items: [...currentOrder.items],
                    subtotal: totalAmount,
                    tax: 0,
                    total: totalAmount,
                    paymentMethod: paymentMethod,
                    receivedAmount: paymentMethod === 'efectivo' ? receivedAmount : totalAmount,
                    changeAmount: paymentMethod === 'efectivo' ? changeAmount : 0,
                    status: 'paid'
                };

                await db.collection('invoices').doc(invoice.id).set(invoice);

                await updateProductStock(currentOrder.items);

                if (!isQuickSale) {
                    await db.collection('mesas').doc(currentMesa).update({
                        items: [],
                        total: 0
                    });
                } else {
                    window.quickOrder = { items: [], total: 0 };
                }

                closePaymentModal();
                updateOrderDisplay();
                renderMesas();
                showPaymentSummary(invoice);
                showNotification('Factura procesada correctamente', 'success');

            } catch (error) {
                console.error('Error al procesar pago:', error);
                showNotification('Error al procesar el pago', 'error');
            }
        }

        function generateInvoiceId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `INV-${timestamp}-${random}`;
        }

        async function updateProductStock(items) {
            try {
                const batch = db.batch();

                items.forEach(item => {
                    const productRef = db.collection('products').doc(item.id);
                    const product = productos.find(p => p.id === item.id);

                    if (product) {
                        const newStock = product.stock - item.quantity;
                        batch.update(productRef, { stock: newStock });
                        product.stock = newStock;
                    }
                });

                await batch.commit();
                renderProducts();
            } catch (error) {
                console.error('Error al actualizar stock:', error);
                showNotification('Error al actualizar stock', 'error');
            }
        }

        function showPaymentSummary(invoice) {
            const itemsHTML = invoice.items.map(item => `
        <tr>
            <td>${item.name}</td>
            <td>${formatCurrency(item.price)}</td>
            <td>x${item.quantity}</td>
            <td>${formatCurrency(item.subtotal)}</td>
        </tr>
    `).join('');

            const efectivoHTML = invoice.paymentMethod === 'efectivo' ? `
        <tr>
            <td colspan="3">Recibido:</td>
            <td>${formatCurrency(invoice.receivedAmount)}</td>
        </tr>
        <tr>
            <td colspan="3">Cambio:</td>
            <td>${formatCurrency(invoice.changeAmount)}</td>
        </tr>
    ` : '';

            const html = `
        <div class="factura-modern">
            <h2 class="titulo">FACTURA</h2>
            <p>BAR RESTAURANTE</p>
            <p>Brink POS System</p>
            <p>${new Date().toLocaleString()}</p>
            <hr>
            <p><strong>ID:</strong> ${invoice.id}</p>
            <p><strong>Mesa:</strong> ${invoice.mesa}</p>
            <p><strong>M√©todo:</strong> ${invoice.paymentMethod.toUpperCase()}</p>
            <table class="factura-tabla">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Cant.</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHTML}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">Subtotal:</td>
                        <td>${formatCurrency(invoice.total)}</td>
                    </tr>
                    <tr>
                        <td colspan="3">IVA (0%):</td>
                        <td>${formatCurrency(0)}</td>
                    </tr>
                    <tr>
                        <td colspan="3"><strong>Total:</strong></td>
                        <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    </tr>
                    ${efectivoHTML}
                </tfoot>
            </table>
            <hr>
            <p class="gracias">¬°GRACIAS POR SU VISITA!</p>
            <p class="gracias">Vuelva pronto</p>
        </div>
    `;

            document.getElementById('invoicePreview').innerHTML = html;
            document.getElementById('invoiceModal').classList.add('active');
        }


        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.remove('active');
        }

        function printInvoice() {
            window.print();
            closeInvoiceModal();
        }

        function centerText(text, width) {
            const pad = Math.max(0, width - text.length);
            const leftPad = Math.floor(pad / 2);
            const rightPad = pad - leftPad;
            return ' '.repeat(leftPad) + text + ' '.repeat(rightPad);
        }

        function formatCurrency(amount) {
            return '$' + amount.toFixed(0);
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>

</html>

<!-- 1 -->